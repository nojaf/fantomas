<!DOCTYPE html>
<html lang="en" data-root="https://fsprojects.github.io/fantomas/">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Florian Verdonck, Jindřich Ivánek, David Schaefer" name="author">
    <!-- Opengraph properties (https://ogp.me/) -->
    <meta property="og:site_name" content="fantomas">
    <meta property="og:title" content="Formatting Conditional Compilation Directives
" />
    <meta property="og:url" content="https://fsprojects.github.io/fantomas/docs/contributors/Conditional Compilation Directives.html">
    <meta property="og:type" content="website" />
    <!-- Twitter cards (https://developer.twitter.com/en/docs/twitter-for-websites/cards/overview/summary-card-with-large-image) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="https://fsprojects.github.io/fantomas/">
    <meta name="twitter:title" content="Formatting Conditional Compilation Directives
">
    
    <title>Formatting Conditional Compilation Directives
 | fantomas</title>
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <link href="https://fsprojects.github.io/fantomas/images/favicon.ico" rel="icon" sizes="32x32" type="image/png"/>
    <script type="application/javascript" src="https://fsprojects.github.io/fantomas/content/fsdocs-theme-set-dark.js"></script>
    <link href="https://fsprojects.github.io/fantomas/content/fsdocs-default.css" rel="stylesheet" type="text/css"/>
    <link href="https://fsprojects.github.io/fantomas/content/fsdocs-theme.css" rel="stylesheet" type="text/css"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;0,600;1,400&family=Reem+Kufi:wght@400;500;700&display=swap" rel="stylesheet">

    
</head>
<body class="content">
<header>
    <div class="start">
        <div id="menu-toggle">
            <iconify-icon class="icon closed" height="22" icon="eva:menu-fill" width="22"></iconify-icon>
            <iconify-icon class="icon open" height="22" icon="mi:close" width="22"></iconify-icon>
            <input type="checkbox" name="mobile-menu" />
            <ul class="menu">
                <li class="nav-header">Links</li>
                <li class="nav-item"><a class="nav-link" href="https://github.com/fsprojects/fantomas/blob/main/LICENSE.md">License</a>
                </li>
                <li class="nav-item"><a class="nav-link"
                                        href="https://github.com/fsprojects/fantomas/blob/main/CHANGELOG.md">Release
                    Notes</a></li>
                <li class="nav-item"><a class="nav-link" href="https://github.com/fsprojects/fantomas/">Source
                    Repository</a></li>
                <li class="nav-header " id="end-users">
    End-users
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GettingStarted.html" class="nav-link" > Getting Started
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/StyleGuide.html" class="nav-link" > Style guide
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Configuration.html" class="nav-link" > Configuration
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/IgnoreFiles.html" class="nav-link" > Ignore Files
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/FormattingCheck.html" class="nav-link" > Formatting Check
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GitHooks.html" class="nav-link" > Git hooks
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Rider.html" class="nav-link" > JetBrains Rider
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/VisualStudio.html" class="nav-link" > Visual Studio
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/VSCode.html" class="nav-link" > Visual Studio Code
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GeneratingCode.html" class="nav-link" > Generating source code
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/UpgradeGuide.html" class="nav-link" > Upgrade guide
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Recipes.html" class="nav-link" > Recipes
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/FAQ.html" class="nav-link" > FAQ
</a></li>

</div>
<li class="nav-header active" id="contributors">
    Contributors
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Index.html" class="nav-link" > Contributors
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/FSharp.html" class="nav-link" > F#
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Getting Started.html" class="nav-link" > Getting started
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Solution Structure.html" class="nav-link" > Solution structure
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Transforming.html" class="nav-link" > Fantomas.Core overview (1)
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Traverse.html" class="nav-link" > Fantomas.Core overview (2)
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Formatted Code.html" class="nav-link" > Fantomas.Core overview (3)
</a></li>

<li class="nav-item active"><a href="https://fsprojects.github.io/fantomas/docs/contributors/Conditional Compilation Directives.html" class="nav-link" > Formatting Conditional Compilation Directives
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/How Can I Contribute.html" class="nav-link" > How can I contribute?
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/The Missing Comment.html" class="nav-link" > The Missing Comment
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Multiple Times.html" class="nav-link" > Fantomas is trying to format the input multiple times due to the detection of multiple defines
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Pull request ground rules.html" class="nav-link" > Pull request ground rules
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Updating the compiler.html" class="nav-link" > Updating the compiler sources
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Releases.html" class="nav-link" > Releases
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Glossary.html" class="nav-link" > Glossary
</a></li>

</div>
                <li class="nav-header " id="api_reference">
    API Reference
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item active"><a href="https://fsprojects.github.io/fantomas/reference/index.html" class="nav-link" > All Namespaces</a></li>

</div>
            </ul>
        </div>
        <a href="https://fsprojects.github.io/fantomas/">
            <img alt="Header menu logo" src="https://fsprojects.github.io/fantomas/images/logo.png">
            <strong>fantomas</strong>
        </a>
    </div>
    <div class="end">
        <a href="https://github.com/fsprojects/fantomas/" target="_blank">
            <iconify-icon icon="uil:github" width="26" height="26"></iconify-icon>
        </a>
        <iconify-icon id="search-btn" icon="carbon:search" class="search" width="24" height="24"></iconify-icon>
        <fsdocs-theme-toggle></fsdocs-theme-toggle>
    </div>
</header>
<aside id="fsdocs-main-menu">
    <ul class="menu">
        <li class="nav-header">Links</li>
        <li class="nav-item"><a class="nav-link" href="https://github.com/fsprojects/fantomas/blob/main/LICENSE.md">License</a>
        </li>
        <li class="nav-item"><a class="nav-link"
                                href="https://github.com/fsprojects/fantomas/blob/main/CHANGELOG.md">Release
            Notes</a></li>
        <li class="nav-item"><a class="nav-link" href="https://github.com/fsprojects/fantomas/">Source
            Repository</a></li>
        <li class="nav-header " id="end-users">
    End-users
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GettingStarted.html" class="nav-link" > Getting Started
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/StyleGuide.html" class="nav-link" > Style guide
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Configuration.html" class="nav-link" > Configuration
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/IgnoreFiles.html" class="nav-link" > Ignore Files
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/FormattingCheck.html" class="nav-link" > Formatting Check
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GitHooks.html" class="nav-link" > Git hooks
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Rider.html" class="nav-link" > JetBrains Rider
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/VisualStudio.html" class="nav-link" > Visual Studio
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/VSCode.html" class="nav-link" > Visual Studio Code
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GeneratingCode.html" class="nav-link" > Generating source code
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/UpgradeGuide.html" class="nav-link" > Upgrade guide
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Recipes.html" class="nav-link" > Recipes
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/FAQ.html" class="nav-link" > FAQ
</a></li>

</div>
<li class="nav-header active" id="contributors">
    Contributors
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Index.html" class="nav-link" > Contributors
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/FSharp.html" class="nav-link" > F#
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Getting Started.html" class="nav-link" > Getting started
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Solution Structure.html" class="nav-link" > Solution structure
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Transforming.html" class="nav-link" > Fantomas.Core overview (1)
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Traverse.html" class="nav-link" > Fantomas.Core overview (2)
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Formatted Code.html" class="nav-link" > Fantomas.Core overview (3)
</a></li>

<li class="nav-item active"><a href="https://fsprojects.github.io/fantomas/docs/contributors/Conditional Compilation Directives.html" class="nav-link" > Formatting Conditional Compilation Directives
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/How Can I Contribute.html" class="nav-link" > How can I contribute?
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/The Missing Comment.html" class="nav-link" > The Missing Comment
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Multiple Times.html" class="nav-link" > Fantomas is trying to format the input multiple times due to the detection of multiple defines
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Pull request ground rules.html" class="nav-link" > Pull request ground rules
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Updating the compiler.html" class="nav-link" > Updating the compiler sources
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Releases.html" class="nav-link" > Releases
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Glossary.html" class="nav-link" > Glossary
</a></li>

</div>
        <li class="nav-header " id="api_reference">
    API Reference
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item active"><a href="https://fsprojects.github.io/fantomas/reference/index.html" class="nav-link" > All Namespaces</a></li>

</div>
    </ul>
</aside>
<main>
    <div id="content">
        
<h1><a name="Formatting-Conditional-Compilation-Directives" class="anchor" href="#Formatting-Conditional-Compilation-Directives">Formatting Conditional Compilation Directives</a></h1>
<p>Fantomas is able to format code that contains <a href="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/compiler-directives#conditional-compilation-directives">conditional compiler directives</a>.<br />
In order to achieve this, Fantomas will actually format the code multiple times and merge all results afterwards.</p>
<h2><a name="Compilation-directives-and-the-syntax-tree" class="anchor" href="#Compilation-directives-and-the-syntax-tree">Compilation directives and the syntax tree</a></h2>
<p>The F# parser will construct a different syntax tree based on the provided compilation directives.<br />
Consider the following piece of code:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="id">a</span> <span class="o">=</span>
    <span class="pp">#if</span> <span class="id">DEBUG</span>
<span class="inactive">    </span><span class="inactive">0</span>
    <span class="pp">#else</span>
    <span class="n">1</span>
    <span class="pp">#endif</span>
</code></pre>
<p>When parsing this code without any directives, the <code>#else</code> branch will be considered the active code path.<br />
The AST would be:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="id">ImplFile</span>
  <span class="pn">(</span><span class="id">ParsedImplFileInput</span>
     <span class="pn">(</span><span class="s">&quot;tmp.fsx&quot;</span><span class="pn">,</span> <span class="k">true</span><span class="pn">,</span> <span class="id">QualifiedNameOfFile</span> <span class="id">Tmp</span><span class="o">$</span><span class="id">fsx</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span>
      <span class="pn">[</span><span class="id">SynModuleOrNamespace</span>
         <span class="pn">(</span><span class="pn">[</span><span class="id">Tmp</span><span class="pn">]</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span class="id">AnonModule</span><span class="pn">,</span>
          <span class="pn">[</span><span class="id">Let</span>
             <span class="pn">(</span><span class="k">false</span><span class="pn">,</span>
              <span class="pn">[</span><span class="id">SynBinding</span>
                 <span class="pn">(</span><span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="id">None</span><span class="pn">,</span> <span class="id">Normal</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span>
                  <span class="id">PreXmlDoc</span> <span class="pn">(</span><span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="pn">)</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="id">FSharp</span><span class="pn">.</span><span class="id">Compiler</span><span class="pn">.</span><span class="id">Xml</span><span class="pn">.</span><span class="id">XmlDocCollector</span><span class="pn">)</span><span class="pn">,</span>
                  <span class="id">SynValData</span>
                    <span class="pn">(</span><span onmouseout="hideTip(event, 'fs2', 4)" onmouseover="showTip(event, 'fs2', 4)" class="id">None</span><span class="pn">,</span> <span class="id">SynValInfo</span> <span class="pn">(</span><span class="pn">[</span><span class="pn">]</span><span class="pn">,</span> <span class="id">SynArgInfo</span> <span class="pn">(</span><span class="pn">[</span><span class="pn">]</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs2', 5)" onmouseover="showTip(event, 'fs2', 5)" class="id">None</span><span class="pn">)</span><span class="pn">)</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs2', 6)" onmouseover="showTip(event, 'fs2', 6)" class="id">None</span><span class="pn">)</span><span class="pn">,</span>
                  <span class="id">Named</span> <span class="pn">(</span><span class="id">SynIdent</span> <span class="pn">(</span><span onmouseout="hideTip(event, 'fs1', 7)" onmouseover="showTip(event, 'fs1', 7)" class="id">a</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs2', 8)" onmouseover="showTip(event, 'fs2', 8)" class="id">None</span><span class="pn">)</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs2', 9)" onmouseover="showTip(event, 'fs2', 9)" class="id">None</span><span class="pn">,</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">1</span><span class="pn">,</span><span class="n">5</span><span class="pn">)</span><span class="pn">)</span><span class="pn">,</span>
                  <span onmouseout="hideTip(event, 'fs2', 10)" onmouseover="showTip(event, 'fs2', 10)" class="id">None</span><span class="pn">,</span> <span class="id">Const</span> <span class="pn">(</span><span class="id">Int32</span> <span class="n">1</span><span class="pn">,</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">5</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">5</span><span class="pn">,</span><span class="n">5</span><span class="pn">)</span><span class="pn">)</span><span class="pn">,</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">1</span><span class="pn">,</span><span class="n">5</span><span class="pn">)</span><span class="pn">,</span>
                  <span class="id">Yes</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="o">--</span><span class="n">5</span><span class="pn">,</span><span class="n">5</span><span class="pn">)</span><span class="pn">,</span>
                  <span class="pn">{</span> <span class="id">LetKeyword</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 11)" onmouseover="showTip(event, 'fs4', 11)" class="id">Some</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="o">--</span><span class="n">1</span><span class="pn">,</span><span class="n">3</span><span class="pn">)</span>
                    <span class="id">EqualsRange</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 12)" onmouseover="showTip(event, 'fs4', 12)" class="id">Some</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">6</span><span class="o">--</span><span class="n">1</span><span class="pn">,</span><span class="n">7</span><span class="pn">)</span> <span class="pn">}</span><span class="pn">)</span><span class="pn">]</span><span class="pn">,</span>
              <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="o">--</span><span class="n">5</span><span class="pn">,</span><span class="n">5</span><span class="pn">)</span><span class="pn">)</span><span class="pn">]</span><span class="pn">,</span> <span class="id">PreXmlDocEmpty</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs2', 13)" onmouseover="showTip(event, 'fs2', 13)" class="id">None</span><span class="pn">,</span>
          <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="o">--</span><span class="n">6</span><span class="pn">,</span><span class="n">10</span><span class="pn">)</span><span class="pn">,</span> <span class="pn">{</span> <span class="id">ModuleKeyword</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 14)" onmouseover="showTip(event, 'fs2', 14)" class="id">None</span>
                                 <span class="id">NamespaceKeyword</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 15)" onmouseover="showTip(event, 'fs2', 15)" class="id">None</span> <span class="pn">}</span><span class="pn">)</span><span class="pn">]</span><span class="pn">,</span> <span class="pn">(</span><span class="k">false</span><span class="pn">,</span> <span class="k">false</span><span class="pn">)</span><span class="pn">,</span>
      <span class="pn">{</span> <span class="id">ConditionalDirectives</span> <span class="o">=</span>
         <span class="pn">[</span><span class="id">If</span> <span class="pn">(</span><span class="id">Ident</span> <span class="s">&quot;DEBUG&quot;</span><span class="pn">,</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">2</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">2</span><span class="pn">,</span><span class="n">13</span><span class="pn">)</span><span class="pn">)</span><span class="pn">;</span> <span class="id">Else</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">4</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">4</span><span class="pn">,</span><span class="n">9</span><span class="pn">)</span><span class="pn">;</span>
          <span class="id">EndIf</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">6</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">6</span><span class="pn">,</span><span class="n">10</span><span class="pn">)</span><span class="pn">]</span>
        <span class="id">CodeComments</span> <span class="o">=</span> <span class="pn">[</span><span class="pn">]</span> <span class="pn">}</span><span class="pn">)</span><span class="pn">)</span>
</code></pre>
<p>Notice that the right hand expression of binding <code>a</code> is <code>Const (Int32 1, ...)</code>.
There is no mention of <code>0</code> as that code was not active and thus is not a part of the syntax tree.</p>
<p>Passing <code>[ "DEBUG" ]</code> to the parser will influence the lexer. The lexer will tokenize the other code branch and take the <code>#if DEBUG</code> path this time.<br />
Leading to</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="id">ImplFile</span>
  <span class="pn">(</span><span class="id">ParsedImplFileInput</span>
     <span class="pn">(</span><span class="s">&quot;tmp.fsx&quot;</span><span class="pn">,</span> <span class="k">true</span><span class="pn">,</span> <span class="id">QualifiedNameOfFile</span> <span class="id">Tmp</span><span class="o">$</span><span class="id">fsx</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span>
      <span class="pn">[</span><span class="id">SynModuleOrNamespace</span>
         <span class="pn">(</span><span class="pn">[</span><span class="id">Tmp</span><span class="pn">]</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span class="id">AnonModule</span><span class="pn">,</span>
          <span class="pn">[</span><span class="id">Let</span>
             <span class="pn">(</span><span class="k">false</span><span class="pn">,</span>
              <span class="pn">[</span><span class="id">SynBinding</span>
                 <span class="pn">(</span><span onmouseout="hideTip(event, 'fs2', 16)" onmouseover="showTip(event, 'fs2', 16)" class="id">None</span><span class="pn">,</span> <span class="id">Normal</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span>
                  <span class="id">PreXmlDoc</span> <span class="pn">(</span><span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="pn">)</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs3', 17)" onmouseover="showTip(event, 'fs3', 17)" class="id">FSharp</span><span class="pn">.</span><span class="id">Compiler</span><span class="pn">.</span><span class="id">Xml</span><span class="pn">.</span><span class="id">XmlDocCollector</span><span class="pn">)</span><span class="pn">,</span>
                  <span class="id">SynValData</span>
                    <span class="pn">(</span><span onmouseout="hideTip(event, 'fs2', 18)" onmouseover="showTip(event, 'fs2', 18)" class="id">None</span><span class="pn">,</span> <span class="id">SynValInfo</span> <span class="pn">(</span><span class="pn">[</span><span class="pn">]</span><span class="pn">,</span> <span class="id">SynArgInfo</span> <span class="pn">(</span><span class="pn">[</span><span class="pn">]</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs2', 19)" onmouseover="showTip(event, 'fs2', 19)" class="id">None</span><span class="pn">)</span><span class="pn">)</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs2', 20)" onmouseover="showTip(event, 'fs2', 20)" class="id">None</span><span class="pn">)</span><span class="pn">,</span>
                  <span class="id">Named</span> <span class="pn">(</span><span class="id">SynIdent</span> <span class="pn">(</span><span onmouseout="hideTip(event, 'fs1', 21)" onmouseover="showTip(event, 'fs1', 21)" class="id">a</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs2', 22)" onmouseover="showTip(event, 'fs2', 22)" class="id">None</span><span class="pn">)</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs2', 23)" onmouseover="showTip(event, 'fs2', 23)" class="id">None</span><span class="pn">,</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">1</span><span class="pn">,</span><span class="n">5</span><span class="pn">)</span><span class="pn">)</span><span class="pn">,</span>
                  <span onmouseout="hideTip(event, 'fs2', 24)" onmouseover="showTip(event, 'fs2', 24)" class="id">None</span><span class="pn">,</span> <span class="id">Const</span> <span class="pn">(</span><span class="id">Int32</span> <span class="n">0</span><span class="pn">,</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">3</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">3</span><span class="pn">,</span><span class="n">5</span><span class="pn">)</span><span class="pn">)</span><span class="pn">,</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">1</span><span class="pn">,</span><span class="n">5</span><span class="pn">)</span><span class="pn">,</span>
                  <span class="id">Yes</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="o">--</span><span class="n">3</span><span class="pn">,</span><span class="n">5</span><span class="pn">)</span><span class="pn">,</span>
                  <span class="pn">{</span> <span class="id">LetKeyword</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 25)" onmouseover="showTip(event, 'fs4', 25)" class="id">Some</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="o">--</span><span class="n">1</span><span class="pn">,</span><span class="n">3</span><span class="pn">)</span>
                    <span class="id">EqualsRange</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 26)" onmouseover="showTip(event, 'fs4', 26)" class="id">Some</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">6</span><span class="o">--</span><span class="n">1</span><span class="pn">,</span><span class="n">7</span><span class="pn">)</span> <span class="pn">}</span><span class="pn">)</span><span class="pn">]</span><span class="pn">,</span>
              <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="o">--</span><span class="n">3</span><span class="pn">,</span><span class="n">5</span><span class="pn">)</span><span class="pn">)</span><span class="pn">]</span><span class="pn">,</span> <span class="id">PreXmlDocEmpty</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs2', 27)" onmouseover="showTip(event, 'fs2', 27)" class="id">None</span><span class="pn">,</span>
          <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="o">--</span><span class="n">6</span><span class="pn">,</span><span class="n">10</span><span class="pn">)</span><span class="pn">,</span> <span class="pn">{</span> <span class="id">ModuleKeyword</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 28)" onmouseover="showTip(event, 'fs2', 28)" class="id">None</span>
                                 <span class="id">NamespaceKeyword</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 29)" onmouseover="showTip(event, 'fs2', 29)" class="id">None</span> <span class="pn">}</span><span class="pn">)</span><span class="pn">]</span><span class="pn">,</span> <span class="pn">(</span><span class="k">false</span><span class="pn">,</span> <span class="k">false</span><span class="pn">)</span><span class="pn">,</span>
      <span class="pn">{</span> <span class="id">ConditionalDirectives</span> <span class="o">=</span>
         <span class="pn">[</span><span class="id">If</span> <span class="pn">(</span><span class="id">Ident</span> <span class="s">&quot;DEBUG&quot;</span><span class="pn">,</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">2</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">2</span><span class="pn">,</span><span class="n">13</span><span class="pn">)</span><span class="pn">)</span><span class="pn">;</span> <span class="id">Else</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">4</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">4</span><span class="pn">,</span><span class="n">9</span><span class="pn">)</span><span class="pn">;</span>
          <span class="id">EndIf</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">6</span><span class="pn">,</span><span class="n">4</span><span class="o">--</span><span class="n">6</span><span class="pn">,</span><span class="n">10</span><span class="pn">)</span><span class="pn">]</span>
        <span class="id">CodeComments</span> <span class="o">=</span> <span class="pn">[</span><span class="pn">]</span> <span class="pn">}</span><span class="pn">)</span><span class="pn">)</span>
</code></pre>
<p>This tree is almost identical but the constant value is now <code>Const (Int32 0, ...)</code>.</p>
<h2><a name="Multiple-trees" class="anchor" href="#Multiple-trees">Multiple trees</a></h2>
<p>As the combination of directives has an influence on the tree, Fantomas first parses the tree without any directives.
This base tree is then being inspected for <a href="https://fsprojects.github.io/fantomas/reference/fsharp-compiler-syntaxtrivia-conditionaldirectivetrivia.html">ConditionalDirectiveTrivia</a>.
We determine the different combinations in the <code>Defines</code> module.</p>
<div class="mermaid text-center">
graph TD
    A["Parse base tree"] --> B
    B["Figure out all compiler define combinations"] --> C
    B --> D
    C["Format tree []"]
    D["Format tree ['DEBUG']"]
    C --> E
    D --> E
    E["Merge results"]
 </div>
<p>As trivia is being restored in each tree, they all will have gaps in them.</p>
<p>The first result will look like:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs1', 30)" onmouseover="showTip(event, 'fs1', 30)" class="id">a</span> <span class="o">=</span>
    <span class="pp">#if</span> <span class="id">DEBUG</span>
    <span class="pp">#else</span>
    <span class="n">1</span>
    <span class="pp">#endif</span>
</code></pre>
<p>and the second:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs5', 31)" onmouseover="showTip(event, 'fs5', 31)" class="id">a</span> <span class="o">=</span>
    <span class="pp">#if</span> <span class="id">DEBUG</span>
<span class="inactive">    </span><span class="inactive">0</span>
    <span class="pp">#else</span>
    <span class="pp">#endif</span>
</code></pre>
<h2><a name="Merging-the-trees" class="anchor" href="#Merging-the-trees">Merging the trees</a></h2>
<p>Once every tree is formatted, we chop each file into fragments.
A fragment is everything between a conditional directive <code>#if | #else | #endif</code> or an actual directive.<br />
This means fragments can also be empty strings.
Each result should have the same amount of fragments before we can merge them together.
If this is not the case, it means that somewhere a trivia was not properly restored.</p>
<p>If the number of fragments add up in each tree, then we merge two trees by reducing both lists and comparing each fragment.<br />
We always take the longest fragment and thus picking the active code.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// fragments of []</span>
<span class="pn">[</span> <span class="s">&quot;let a =&quot;</span><span class="pn">;</span> <span class="s">&quot;#if DEBUG&quot;</span><span class="pn">;</span> <span class="s">&quot;&quot;</span><span class="pn">;</span> <span class="s">&quot;#else&quot;</span><span class="pn">;</span> <span class="s">&quot;1&quot;</span><span class="pn">;</span> <span class="s">&quot;#endif&quot;</span> <span class="pn">]</span>

<span class="c">// fragments of [ &quot;DEBUG&quot; ]</span>
<span class="pn">[</span> <span class="s">&quot;let a =&quot;</span><span class="pn">;</span> <span class="s">&quot;#if DEBUG&quot;</span><span class="pn">;</span> <span class="s">&quot;0&quot;</span><span class="pn">;</span> <span class="s">&quot;#else&quot;</span><span class="pn">;</span> <span class="s">&quot;&quot;</span><span class="pn">;</span> <span class="s">&quot;#endif&quot;</span> <span class="pn">]</span>
</code></pre>
<p>After merging:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="pn">[</span> <span class="s">&quot;let a =&quot;</span><span class="pn">;</span> <span class="s">&quot;#if DEBUG&quot;</span><span class="pn">;</span> <span class="s">&quot;0&quot;</span><span class="pn">;</span> <span class="s">&quot;#else&quot;</span><span class="pn">;</span> <span class="s">&quot;1&quot;</span><span class="pn">;</span> <span class="s">&quot;#endif&quot;</span> <span class="pn">]</span>
</code></pre>
<fantomas-nav previous="Formatted%20Code.html" next="How%20Can%20I%20Contribute.html"></fantomas-nav>

        <div class="fsdocs-tip" id="fs1">val a: int</div>
<div class="fsdocs-tip" id="fs2">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="fsdocs-tip" id="fs3">namespace Microsoft.FSharp</div>
<div class="fsdocs-tip" id="fs4">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="fsdocs-tip" id="fs5">val a: &#39;a</div>

    </div>
</main>
<aside id="fsdocs-page-menu">
    <p id="on-this-page">On this page</p>
    <ul>
  <li class="level-1">
    <a href="#Formatting-Conditional-Compilation-Directives">
      Formatting Conditional Compilation Directives
    </a>
  </li>
  <li class="level-2">
    <a href="#Compilation-directives-and-the-syntax-tree">
      Compilation directives and the syntax tree
    </a>
  </li>
  <li class="level-2">
    <a href="#Multiple-trees">
      Multiple trees
    </a>
  </li>
  <li class="level-2">
    <a href="#Merging-the-trees">
      Merging the trees
    </a>
  </li>
</ul>
</aside>
<dialog>
    <input type="search" placeholder="Search docs" />
    <div class="results">
        <ul></ul>
        <p class="empty">Type something to start searching.</p>
    </div>
</dialog>
<script type="module" src="https://fsprojects.github.io/fantomas/content/fsdocs-tips.js"></script>
<script type="module" src="https://fsprojects.github.io/fantomas/content/fsdocs-theme-toggle.js"></script>
<script type="module" src="https://fsprojects.github.io/fantomas/content/fsdocs-theme.js"></script>
<script type="module" src="https://fsprojects.github.io/fantomas/content/fsdocs-search.js"></script>
<script type="module">
    import mermaid from "https://esm.sh/mermaid@9.2.2";
    mermaid.initialize({
        startOnLoad: true,
        theme: "base",
        themeVariables: {
            primaryColor: '#338cbb',
            primaryTextColor: '#FFF',
            primaryBorderColor: '#5aacd6'
        }
    });

    const menuHeaders = [...document.querySelectorAll(".nav-header")].filter(nh => nh.id);
    menuHeaders.forEach(nv => {
        nv.addEventListener("click", () => {
            nv.classList.toggle("active");
        })
    })
</script>
<script type="module" src="https://fsprojects.github.io/fantomas/content/webcomponents.js"></script>
</body>
</html>