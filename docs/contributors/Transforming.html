<!DOCTYPE html>
<html lang="en" data-root="https://fsprojects.github.io/fantomas/">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Florian Verdonck, Jindřich Ivánek, David Schaefer" name="author">
    <!-- Opengraph properties (https://ogp.me/) -->
    <meta property="og:site_name" content="fantomas">
    <meta property="og:title" content="Fantomas.Core overview (1)
" />
    <meta property="og:url" content="https://fsprojects.github.io/fantomas/docs/contributors/Transforming.html">
    <meta property="og:type" content="website" />
    <!-- Twitter cards (https://developer.twitter.com/en/docs/twitter-for-websites/cards/overview/summary-card-with-large-image) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="https://fsprojects.github.io/fantomas/">
    <meta name="twitter:title" content="Fantomas.Core overview (1)
">
    
    <title>Fantomas.Core overview (1)
 | fantomas</title>
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <link href="https://fsprojects.github.io/fantomas/images/favicon.ico" rel="icon" sizes="32x32" type="image/png"/>
    <script type="application/javascript" src="https://fsprojects.github.io/fantomas/content/fsdocs-theme-set-dark.js"></script>
    <link href="https://fsprojects.github.io/fantomas/content/fsdocs-default.css" rel="stylesheet" type="text/css"/>
    <link href="https://fsprojects.github.io/fantomas/content/fsdocs-theme.css" rel="stylesheet" type="text/css"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;0,600;1,400&family=Reem+Kufi:wght@400;500;700&display=swap" rel="stylesheet">

    
</head>
<body class="content">
<header>
    <div class="start">
        <div id="menu-toggle">
            <iconify-icon class="icon closed" height="22" icon="eva:menu-fill" width="22"></iconify-icon>
            <iconify-icon class="icon open" height="22" icon="mi:close" width="22"></iconify-icon>
            <input type="checkbox" name="mobile-menu" />
            <ul class="menu">
                <li class="nav-header">Links</li>
                <li class="nav-item"><a class="nav-link" href="https://github.com/fsprojects/fantomas/blob/main/LICENSE.md">License</a>
                </li>
                <li class="nav-item"><a class="nav-link"
                                        href="https://github.com/fsprojects/fantomas/blob/main/CHANGELOG.md">Release
                    Notes</a></li>
                <li class="nav-item"><a class="nav-link" href="https://github.com/fsprojects/fantomas/">Source
                    Repository</a></li>
                <li class="nav-header " id="end-users">
    End-users
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GettingStarted.html" class="nav-link" > Getting Started
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/StyleGuide.html" class="nav-link" > Style guide
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Configuration.html" class="nav-link" > Configuration
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/IgnoreFiles.html" class="nav-link" > Ignore Files
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/FormattingCheck.html" class="nav-link" > Formatting Check
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GitHooks.html" class="nav-link" > Git hooks
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Rider.html" class="nav-link" > JetBrains Rider
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/VisualStudio.html" class="nav-link" > Visual Studio
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/VSCode.html" class="nav-link" > Visual Studio Code
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GeneratingCode.html" class="nav-link" > Generating source code
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/UpgradeGuide.html" class="nav-link" > Upgrade guide
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Recipes.html" class="nav-link" > Recipes
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/FAQ.html" class="nav-link" > FAQ
</a></li>

</div>
<li class="nav-header active" id="contributors">
    Contributors
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Index.html" class="nav-link" > Contributors
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/FSharp.html" class="nav-link" > F#
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Getting Started.html" class="nav-link" > Getting started
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Solution Structure.html" class="nav-link" > Solution structure
</a></li>

<li class="nav-item active"><a href="https://fsprojects.github.io/fantomas/docs/contributors/Transforming.html" class="nav-link" > Fantomas.Core overview (1)
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Traverse.html" class="nav-link" > Fantomas.Core overview (2)
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Formatted Code.html" class="nav-link" > Fantomas.Core overview (3)
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Conditional Compilation Directives.html" class="nav-link" > Formatting Conditional Compilation Directives
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/How Can I Contribute.html" class="nav-link" > How can I contribute?
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/The Missing Comment.html" class="nav-link" > The Missing Comment
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Multiple Times.html" class="nav-link" > Fantomas is trying to format the input multiple times due to the detection of multiple defines
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Pull request ground rules.html" class="nav-link" > Pull request ground rules
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Updating the compiler.html" class="nav-link" > Updating the compiler sources
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Releases.html" class="nav-link" > Releases
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Glossary.html" class="nav-link" > Glossary
</a></li>

</div>
                <li class="nav-header " id="api_reference">
    API Reference
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item active"><a href="https://fsprojects.github.io/fantomas/reference/index.html" class="nav-link" > All Namespaces</a></li>

</div>
            </ul>
        </div>
        <a href="https://fsprojects.github.io/fantomas/">
            <img alt="Header menu logo" src="https://fsprojects.github.io/fantomas/images/logo.png">
            <strong>fantomas</strong>
        </a>
    </div>
    <div class="end">
        <a href="https://github.com/fsprojects/fantomas/" target="_blank">
            <iconify-icon icon="uil:github" width="26" height="26"></iconify-icon>
        </a>
        <iconify-icon id="search-btn" icon="carbon:search" class="search" width="24" height="24"></iconify-icon>
        <fsdocs-theme-toggle></fsdocs-theme-toggle>
    </div>
</header>
<aside id="fsdocs-main-menu">
    <ul class="menu">
        <li class="nav-header">Links</li>
        <li class="nav-item"><a class="nav-link" href="https://github.com/fsprojects/fantomas/blob/main/LICENSE.md">License</a>
        </li>
        <li class="nav-item"><a class="nav-link"
                                href="https://github.com/fsprojects/fantomas/blob/main/CHANGELOG.md">Release
            Notes</a></li>
        <li class="nav-item"><a class="nav-link" href="https://github.com/fsprojects/fantomas/">Source
            Repository</a></li>
        <li class="nav-header " id="end-users">
    End-users
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GettingStarted.html" class="nav-link" > Getting Started
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/StyleGuide.html" class="nav-link" > Style guide
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Configuration.html" class="nav-link" > Configuration
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/IgnoreFiles.html" class="nav-link" > Ignore Files
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/FormattingCheck.html" class="nav-link" > Formatting Check
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GitHooks.html" class="nav-link" > Git hooks
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Rider.html" class="nav-link" > JetBrains Rider
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/VisualStudio.html" class="nav-link" > Visual Studio
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/VSCode.html" class="nav-link" > Visual Studio Code
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/GeneratingCode.html" class="nav-link" > Generating source code
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/UpgradeGuide.html" class="nav-link" > Upgrade guide
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/Recipes.html" class="nav-link" > Recipes
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/end-users/FAQ.html" class="nav-link" > FAQ
</a></li>

</div>
<li class="nav-header active" id="contributors">
    Contributors
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Index.html" class="nav-link" > Contributors
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/FSharp.html" class="nav-link" > F#
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Getting Started.html" class="nav-link" > Getting started
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Solution Structure.html" class="nav-link" > Solution structure
</a></li>

<li class="nav-item active"><a href="https://fsprojects.github.io/fantomas/docs/contributors/Transforming.html" class="nav-link" > Fantomas.Core overview (1)
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Traverse.html" class="nav-link" > Fantomas.Core overview (2)
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Formatted Code.html" class="nav-link" > Fantomas.Core overview (3)
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Conditional Compilation Directives.html" class="nav-link" > Formatting Conditional Compilation Directives
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/How Can I Contribute.html" class="nav-link" > How can I contribute?
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/The Missing Comment.html" class="nav-link" > The Missing Comment
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Multiple Times.html" class="nav-link" > Fantomas is trying to format the input multiple times due to the detection of multiple defines
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Pull request ground rules.html" class="nav-link" > Pull request ground rules
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Updating the compiler.html" class="nav-link" > Updating the compiler sources
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Releases.html" class="nav-link" > Releases
</a></li>

<li class="nav-item "><a href="https://fsprojects.github.io/fantomas/docs/contributors/Glossary.html" class="nav-link" > Glossary
</a></li>

</div>
        <li class="nav-header " id="api_reference">
    API Reference
    <iconify-icon icon="fluent:chevron-up-24-regular" width="32" height="32" rotate="180deg"></iconify-icon>
</li>
<div class="menu-items">
    <li class="nav-item active"><a href="https://fsprojects.github.io/fantomas/reference/index.html" class="nav-link" > All Namespaces</a></li>

</div>
    </ul>
</aside>
<main>
    <div id="content">
        
<h1><a name="Fantomas-Core-overview-1" class="anchor" href="#Fantomas-Core-overview-1">Fantomas.Core overview (1)</a></h1>
<p>In its simplest form, Fantomas.Core works in two major phases: transform the raw source code to a custom tree model and traverse that custom tree to print the formatted code.</p>
<div class="mermaid text-center">
graph TD
    A[Transform source code to Oak] --> B
    B[Traverse Oak to get formatted code] --> C[Formatted code]
    style A stroke:#338CBB,stroke-width:2px
 </div>
<p>Unfortunately, both phases are not always very straight forward.<br />
But once you get hang of the first phase, you can easily understand the second phase.</p>
<h2><a name="Processing-the-raw-source" class="anchor" href="#Processing-the-raw-source">Processing the raw source</a></h2>
<p>To have an understanding of what the raw source code means we parse the code using the parser of the F# compiler.<br />
We can parse the source code into an untyped syntax tree. This tree isn't really perfect for our use-case, so we map it to an <code>Oak</code>.<br />
An <code>Oak</code> is the toplevel root node of the Fantomas tree. We use a custom tree because it better suites our needs to reconstruct the output code.</p>
<div class="mermaid text-center">
graph TD
    A[Parse AST] --> B
    B[Transfrom untyped AST to OAK] --> C
    C[Enrich the Oak with Trivia]
</div>
<h3><a name="Parse-AST" class="anchor" href="#Parse-AST">Parse AST</a></h3>
<p>Parsing the AST is straightforward. We use the <code>parseFile</code> function from <code>Fantomas.FCS</code> and get back a syntax tree and diagnostic information.<br />
The diagnostic information is used to report errors and warnings. When we have errors, we stop processing the file.</p>
<p><strong>Fantomas requires a valid source code to format.</strong></p>
<p>If your code has errors, the parser cannot return a complete AST which is a strict requirement to run the remaining phases.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="id">a</span> <span class="o">=</span>
</code></pre>
<p>Returns a parsing error <code>Incomplete structured construct at or before this point in binding</code>.
This has <code>FSharpDiagnosticSeverity.Error</code> and Fantomas will not process any code that has those.</p>
<p>When there are only warnings, Fantomas will still try to process the file but will always yield a result.</p>
<p><code>parseFile</code> takes three parameters:
- <code>isSignature: bool</code></p>
<p>The Syntax tree for a signature is a little different than a regular source file. The parser needs to know this and throughout the rest of the process, signature ASTs are treated differently.</p>
<ul>
<li><code>sourceText: ISourceText</code></li>
</ul>
<p>The input source code string is converted to an <a href="https://fsprojects.github.io/fantomas/reference/fsharp-compiler-text-isourcetext.html">ISourceText</a>) internally.</p>
<ul>
<li><code>defines: string list</code></li>
</ul>
<p>Conditional compilation defines are passed to the parser. These can have an influence on the parsing process, resulting in different ASTs.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="id">a</span> <span class="o">=</span>
    <span class="pp">#if</span> <span class="id">DEBUG</span>
<span class="inactive">    </span><span class="inactive">0</span>
    <span class="pp">#else</span>
    <span class="n">1</span>
    <span class="pp">#endif</span>
</code></pre>
<p>Depending on the defines <code>[]</code> or <code>["DEBUG"]</code>, the AST will be different.
The tree will also be created based on a single code path.</p>
<h3><a name="Transform-untyped-AST-to-Oak" class="anchor" href="#Transform-untyped-AST-to-Oak">Transform untyped AST to Oak</a></h3>
<p>The untyped syntax tree from the F# compiler is used as an intermediate representation of source code in the process of transforming a text file to binary.<br />
The AST is optimized for the use-case of generating binary. What we try to do in Fantomas is stop at the first AST level and go back to source text.</p>
<p>The F# compiler was never designed with our use-case in mind and yet it has served us very well for years.
In the past we did not have our own tree and were able to pull of formatting by traversing the compiler tree.
This of course had its limitations and we had to overcome these with some hacks.</p>
<p>Alas, some things in the AST aren't shaped the way we would like them to be. Sometimes, there is too much information, other times to little.
To stream line our entire process, we've decided to map the untyped tree to our own custom object model.
This introduces a lot of flexibility and simplifies our story.</p>
<blockquote>
<p>I thought Fangorn was dangerous - Gimli, son of Glóin</p>
</blockquote>
<p>In <code>ASTTransformer.fs</code> we map the AST to our tree model. Some of the benefits we get out of this:</p>
<ul>
<li>The Oak model does not differentiate between implementation files and signature files. We use one tree model which allows for optimal code re-use in <code>CodePrinter.fs</code>.</li>
<li>
We don't map all possible combinations of AST into our model. Sometimes valid AST code can in theory be created, 
but will in practise never exist. For example <a href="../../reference/fsharp-compiler-syntax-syntypedefnrepr.html#Exception">SynTypeDefnRepr.Exception</a>. It is defined in <code>SyntaxTree.fs</code> yet the parser (<code>pars.fs</code>) will never create it.
The F# compiler uses this later in the typed tree. We will throw an exception when encountering this during the mapping as we have the foresight of what the parser doesn't create.
</li>
<li>Recursive types are all considered as toplevel types. This is not the case in the AST but we map it as such.</li>
<li>Some nodes are combined into one, for example a toplevel attribute will always be linked to its sibling do expression.</li>
<li>The ranges of some nodes are being calculated when they lead to a more accurate result.</li>
</ul>
<h3><a name="Collect-Trivia" class="anchor" href="#Collect-Trivia">Collect Trivia</a></h3>
<p>A syntax tree contains almost all the information we need to format the code.
However, there are three items that are either missing all together or require further processing:</p>
<ul>
<li>Blank lines</li>
<li>Code comments</li>
<li>Conditional directives</li>
</ul>
<p>These three items are labelled as <code>Trivia</code> in Fantomas. We need to restore them because the source code originally had them, but cannot do so purely on the AST.</p>
<h4><a name="Detecting-trivia" class="anchor" href="#Detecting-trivia">Detecting trivia</a></h4>
<p>Trivia can however be easily detected in Fantomas. Both code comments and conditional directives are present in the AST.
These are stored on the file level (in <a href="https://fsprojects.github.io/fantomas/reference/fsharp-compiler-syntax-parsedimplfileinput.html">ParsedImplFileInput</a> and  <a href="https://fsprojects.github.io/fantomas/reference/fsharp-compiler-syntax-parsedsigfileinput.html">ParsedSigFileInput</a> in the <code>trivia</code> node).</p>
<p>In both <a href="https://fsprojects.github.io/fantomas/reference/fsharp-compiler-syntaxtrivia-parsedimplfileinputtrivia.html">ParsedImplFileInputTrivia</a> and <a href="https://fsprojects.github.io/fantomas/reference/fsharp-compiler-syntaxtrivia-parsedsigfileinputtrivia.html">ParsedSigFileInputTrivia</a> we can see comments and conditional directives.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="id">a</span> <span class="o">=</span> 
   <span class="c">// comment b</span>
   <span class="id">c</span>
</code></pre>
<p>roughly translates to</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="id">ImplFile</span>
  <span class="pn">(</span><span class="id">ParsedImplFileInput</span>
     <span class="pn">(</span><span class="s">&quot;tmp.fsx&quot;</span><span class="pn">,</span> <span class="k">true</span><span class="pn">,</span> <span class="id">QualifiedNameOfFile</span> <span class="id">Tmp</span><span class="o">$</span><span class="id">fsx</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span>
      <span class="pn">[</span><span class="id">SynModuleOrNamespace</span>
         <span class="pn">(</span><span class="pn">[</span><span class="id">Tmp</span><span class="pn">]</span><span class="pn">,</span> <span class="k">false</span><span class="pn">,</span> <span class="id">AnonModule</span><span class="pn">,</span>
          <span class="pn">[</span><span class="id">Let</span>
             <span class="pn">(</span><span class="k">false</span><span class="pn">,</span>
              <span class="pn">[</span><span class="id">SynBinding</span><span class="pn">(</span><span class="o">..</span><span class="pn">.</span><span class="pn">)</span><span class="pn">]</span><span class="pn">,</span>
              <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="o">--</span><span class="n">3</span><span class="pn">,</span><span class="n">4</span><span class="pn">)</span><span class="pn">)</span><span class="pn">]</span><span class="pn">,</span> <span class="id">PreXmlDocEmpty</span><span class="pn">,</span> <span class="pn">[</span><span class="pn">]</span><span class="pn">,</span> <span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="id">None</span><span class="pn">,</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">1</span><span class="pn">,</span><span class="n">0</span><span class="o">--</span><span class="n">3</span><span class="pn">,</span><span class="n">4</span><span class="pn">)</span><span class="pn">,</span>
          <span class="pn">{</span> <span class="id">ModuleKeyword</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="id">None</span>
            <span class="id">NamespaceKeyword</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 6)" onmouseover="showTip(event, 'fs4', 6)" class="id">None</span> <span class="pn">}</span><span class="pn">)</span><span class="pn">]</span><span class="pn">,</span> <span class="pn">(</span><span class="k">false</span><span class="pn">,</span> <span class="k">false</span><span class="pn">)</span><span class="pn">,</span>
      <span class="pn">{</span> <span class="id">ConditionalDirectives</span> <span class="o">=</span> <span class="pn">[</span><span class="pn">]</span>
        <span class="id">CodeComments</span> <span class="o">=</span> <span class="pn">[</span><span class="id">LineComment</span> <span class="id">tmp</span><span class="pn">.</span><span class="id">fsx</span> <span class="pn">(</span><span class="n">2</span><span class="pn">,</span><span class="n">3</span><span class="o">--</span><span class="n">2</span><span class="pn">,</span><span class="n">15</span><span class="pn">)</span><span class="pn">]</span> <span class="pn">}</span><span class="pn">)</span><span class="pn">)</span>
</code></pre>
<p>The AST does contain a node for the line comment, but we cannot restore it when we are processing the let binding.<br />
There is no link between the line comment and the let binding.</p>
<p>All trivia face this problem, so we need to process them separately.<br />
We do this in <code>Trivia.collectTrivia</code>.</p>
<p>Note: blank lines are detected differently, we go over all the lines via the <code>ISourceText</code>.</p>
<h4><a name="Inserting-trivia" class="anchor" href="#Inserting-trivia">Inserting trivia</a></h4>
<p>Once we have the trivia, we can insert them to a <code>Node</code> they belong to.
This is one of the key reasons why we work with our own tree. We can add the trivia information to the best suitable child node in the <code>Oak</code>.
Every <code>Node</code> can have <code>ContentBefore</code> and <code>ContentAfter</code>, this is how we try to reconstruct everything.</p>
<div class="mermaid text-center">
graph TD
    A[Capture all trivia from AST and ISourceText] --> B
    B[Insert trivia into nodes]
 </div>
<fantomas-nav previous="Solution%20Structure.html" next="Traverse.html"></fantomas-nav>

        <div class="fsdocs-tip" id="fs1">val a: &#39;a</div>
<div class="fsdocs-tip" id="fs2">val a: int</div>
<div class="fsdocs-tip" id="fs3">val a: obj</div>
<div class="fsdocs-tip" id="fs4">union case Option.None: Option&lt;&#39;T&gt;</div>

    </div>
</main>
<aside id="fsdocs-page-menu">
    <p id="on-this-page">On this page</p>
    <ul>
  <li class="level-1">
    <a href="#Fantomas-Core-overview-1">
      Fantomas.Core overview (1)
    </a>
  </li>
  <li class="level-2">
    <a href="#Processing-the-raw-source">
      Processing the raw source
    </a>
  </li>
  <li class="level-3">
    <a href="#Parse-AST">
      Parse AST
    </a>
  </li>
  <li class="level-3">
    <a href="#Transform-untyped-AST-to-Oak">
      Transform untyped AST to Oak
    </a>
  </li>
  <li class="level-3">
    <a href="#Collect-Trivia">
      Collect Trivia
    </a>
  </li>
  <li class="level-4">
    <a href="#Detecting-trivia">
      Detecting trivia
    </a>
  </li>
  <li class="level-4">
    <a href="#Inserting-trivia">
      Inserting trivia
    </a>
  </li>
</ul>
</aside>
<dialog>
    <input type="search" placeholder="Search docs" />
    <div class="results">
        <ul></ul>
        <p class="empty">Type something to start searching.</p>
    </div>
</dialog>
<script type="module" src="https://fsprojects.github.io/fantomas/content/fsdocs-tips.js"></script>
<script type="module" src="https://fsprojects.github.io/fantomas/content/fsdocs-theme-toggle.js"></script>
<script type="module" src="https://fsprojects.github.io/fantomas/content/fsdocs-theme.js"></script>
<script type="module" src="https://fsprojects.github.io/fantomas/content/fsdocs-search.js"></script>
<script type="module">
    import mermaid from "https://esm.sh/mermaid@9.2.2";
    mermaid.initialize({
        startOnLoad: true,
        theme: "base",
        themeVariables: {
            primaryColor: '#338cbb',
            primaryTextColor: '#FFF',
            primaryBorderColor: '#5aacd6'
        }
    });

    const menuHeaders = [...document.querySelectorAll(".nav-header")].filter(nh => nh.id);
    menuHeaders.forEach(nv => {
        nv.addEventListener("click", () => {
            nv.classList.toggle("active");
        })
    })
</script>
<script type="module" src="https://fsprojects.github.io/fantomas/content/webcomponents.js"></script>
</body>
</html>